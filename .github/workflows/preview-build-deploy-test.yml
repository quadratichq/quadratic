name: Preview

on:
  pull_request:
    types: [synchronize, reopened, labeled, unlabeled]

# Concurrency: cancel in-progress builds for:
# - synchronize: new code pushes should cancel old builds
# - unlabeled with 'preview': removing preview label should cancel the build
# For other events (labeled, reopened), queue behind any running build.
concurrency:
  group: pr-${{ github.event.pull_request.number }}-preview-build
  cancel-in-progress: ${{ github.event.action == 'synchronize' || (github.event.action == 'unlabeled' && github.event.label.name == 'preview') }}

jobs:
  create_deployment:
    name: Create Deployment
    # Only run for preview-labeled PRs on valid events (skip qa->main PRs)
    if: |
      (github.head_ref != 'qa' || github.base_ref != 'main') &&
      contains(github.event.pull_request.labels.*.name, 'preview') &&
      (github.event.action == 'synchronize' ||
       github.event.action == 'reopened' ||
       (github.event.action == 'labeled' && github.event.label.name == 'preview'))
    permissions:
      contents: read
      pull-requests: write
      issues: write
      deployments: write
    runs-on: blacksmith-2vcpu-ubuntu-2404
    timeout-minutes: 5
    outputs:
      deployment_id: ${{ steps.deployment.outputs.id }}
    steps:
      - name: Find Build & Deploy Images Comment
        uses: peter-evans/find-comment@v3
        id: preview-build-deploy-images-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: "github-actions[bot]"
          body-includes: "Preview - Build, Deploy & Tests-E2E"

      - name: Create initial status comment
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ steps.preview-build-deploy-images-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## Preview - Build, Deploy & Tests-E2E
            ‚è≥ Building images...
            ‚è≥ Deploy images
            ‚è≥ Tests-E2E - [Previous Report](https://e2e.quadratic-preview.com/pr-${{ github.event.pull_request.number }})

            üîç Track progress in the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          edit-mode: replace

      - name: Deactivate previous deployments
        run: |
          gh api \
            --method GET \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/deployments \
            -f ref="${{ github.event.pull_request.head.ref }}" \
            -f environment=preview-pr-${{ github.event.pull_request.number }} \
            --jq '.[] | .id' | while read -r id; do
              gh api \
                --method POST \
                -H "Accept: application/vnd.github+json" \
                /repos/${{ github.repository }}/deployments/$id/statuses \
                -f state="inactive" \
                -f environment="preview-pr-${{ github.event.pull_request.number }}" \
                -f description="Superseded by newer deployment"
            done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create deployment
        id: deployment
        run: |
          DEPLOYMENT_ID=$(gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/deployments \
            -f ref="${{ github.event.pull_request.head.ref }}" \
            -f description="Building and deploying PR #${{ github.event.pull_request.number }} (${GITHUB_SHA::7})" \
            -F auto_merge=false \
            -f required_contexts\[\] \
            -f environment=preview-pr-${{ github.event.pull_request.number }} \
            -F transient_environment=true \
            -F production_environment=false \
            --jq '.id')
          echo "id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update deployment status (building images)
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/deployments/${{ steps.deployment.outputs.id }}/statuses \
            -f state="in_progress" \
            -f description="Building Docker images..." \
            -f environment=preview-pr-${{ github.event.pull_request.number }} \
            -f log_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build_images:
    name: Build Images
    needs: create_deployment
    permissions:
      contents: read
      pull-requests: write
      issues: write
      deployments: write
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 40
    outputs:
      version: ${{ steps.read-version.outputs.version }}
    strategy:
      matrix:
        include:
          - service: client
            runner: blacksmith-4vcpu-ubuntu-2404
          - service: api
            runner: blacksmith-2vcpu-ubuntu-2404
          - service: connection
            runner: blacksmith-4vcpu-ubuntu-2404
          - service: files
            runner: blacksmith-4vcpu-ubuntu-2404
          - service: multiplayer
            runner: blacksmith-4vcpu-ubuntu-2404
          - service: cloud-controller
            runner: blacksmith-4vcpu-ubuntu-2404
          - service: cloud-worker
            runner: blacksmith-4vcpu-ubuntu-2404
      fail-fast: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Read version
        id: read-version
        if: matrix.service == 'client'
        run: |
          VERSION=$(cat VERSION)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Cache Pyodide
        if: matrix.service == 'client'
        uses: useblacksmith/cache@v5
        with:
          path: quadratic-client/public/pyodide
          key: pyodide-${{ hashFiles('quadratic-client/download-pyodide.sh') }}

      - name: Download & Verify Pyodide
        if: matrix.service == 'client'
        run: |
          npm run client:download:pyodide

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_PREVIEW }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_PREVIEW }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR Private
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Define repository name
        id: repo-name
        run: |
          echo "REPO_NAME=quadratic-${{ matrix.service }}" >> $GITHUB_OUTPUT

      - name: Create Private ECR Repository
        id: create-ecr
        env:
          REPO_NAME: ${{ steps.repo-name.outputs.REPO_NAME }}
        run: |
          # Try to describe the repository first
          if ! aws ecr describe-repositories --repository-names $REPO_NAME 2>/dev/null; then
            # Repository doesn't exist, create it
            aws ecr create-repository --repository-name $REPO_NAME || true
          fi

          # Get the repository URI either way
          REPO_INFO=$(aws ecr describe-repositories --repository-names $REPO_NAME)
          ECR_URL=$(echo $REPO_INFO | jq -r '.repositories[0].repositoryUri')
          echo "ECR_URL=$ECR_URL" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: quadratic-${{ matrix.service }}/Dockerfile
          push: true
          tags: ${{ steps.create-ecr.outputs.ECR_URL }}:pr-${{ github.event.pull_request.number }}
          build-args: |
            SKIP_COMPRESSION=true
          cache-from: type=registry,ref=${{ steps.create-ecr.outputs.ECR_URL }}:pr-${{ github.event.pull_request.number }}-build-cache
          cache-to: type=registry,mode=max,image-manifest=true,oci-mediatypes=true,compression=zstd,force-compression=true,ref=${{ steps.create-ecr.outputs.ECR_URL }}:pr-${{ github.event.pull_request.number }}-build-cache

      - name: Find Build & Deploy Images Comment
        if: failure()
        uses: peter-evans/find-comment@v3
        id: preview-build-deploy-images-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: "github-actions[bot]"
          body-includes: "Preview - Build, Deploy & Tests-E2E"

      - name: Update comment on build images failure
        if: failure()
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ steps.preview-build-deploy-images-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## Preview - Build, Deploy & Tests-E2E
            ‚ùå Build images
            ‚ùå Deploy images
            ‚ùå Tests-E2E

            üîç Please check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.
          edit-mode: replace

      - name: Update deployment status (failure)
        if: failure()
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/deployments/${{ needs.create_deployment.outputs.deployment_id }}/statuses \
            -f state="failure" \
            -f description="Failed to build ${{ matrix.service }} image" \
            -f environment=preview-pr-${{ github.event.pull_request.number }} \
            -f log_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Find Build & Deploy Images Comment (cancelled)
        if: cancelled()
        uses: peter-evans/find-comment@v3
        id: preview-build-deploy-images-comment-cancelled
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: "github-actions[bot]"
          body-includes: "Preview - Build, Deploy & Tests-E2E"

      - name: Update comment on build images cancelled
        if: cancelled()
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ steps.preview-build-deploy-images-comment-cancelled.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## Preview - Build, Deploy & Tests-E2E
            üö´ Build images - [Cancelled](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            üö´ Deploy images
            üö´ Tests-E2E

            üîç [Workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          edit-mode: replace

  deploy_images:
    name: Deploy Images
    needs: [create_deployment, build_images]
    permissions:
      contents: read
      pull-requests: write
      issues: write
      deployments: write
    runs-on: blacksmith-2vcpu-ubuntu-2404
    timeout-minutes: 30
    outputs:
      WEBSITE_URL: ${{ steps.deploy-metadata.outputs.WEBSITE_URL }}
      DEPLOY_TIME: ${{ steps.deploy-metadata.outputs.DEPLOY_TIME }}
    env:
      STACK_NAME: pr-${{ github.event.pull_request.number }}
      MAX_ATTEMPTS: 80
    steps:
      - name: Find Build & Deploy Images Comment
        uses: peter-evans/find-comment@v3
        id: preview-build-deploy-images-comment-start
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: "github-actions[bot]"
          body-includes: "Preview - Build, Deploy & Tests-E2E"

      - name: Update comment on deploy images start
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ steps.preview-build-deploy-images-comment-start.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## Preview - Build, Deploy & Tests-E2E
            ‚úÖ Build images
            ‚è≥ Deploying images...
            ‚è≥ Tests-E2E - [Previous Report](https://e2e.quadratic-preview.com/pr-${{ github.event.pull_request.number }})

            üîç Track progress in the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          edit-mode: replace

      - name: Update deployment status (deploying)
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/deployments/${{ needs.create_deployment.outputs.deployment_id }}/statuses \
            -f state="in_progress" \
            -f description="Deploying images..." \
            -f environment=preview-pr-${{ github.event.pull_request.number }} \
            -f log_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_PREVIEW }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_PREVIEW }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Wait for stack deployment
        id: check-stack
        run: |
          ATTEMPTS=0
          echo "Waiting for stack deployment..."
          while [ $ATTEMPTS -lt ${{ env.MAX_ATTEMPTS }} ]; do
            if ! STATUS=$(aws cloudformation describe-stacks \
              --stack-name ${{ env.STACK_NAME }} \
              --query 'Stacks[0].StackStatus' \
              --output text 2>&1); then
              echo "Error getting stack status: $STATUS"
              echo "Stack might not exist yet. Waiting..."
              sleep 30
              ATTEMPTS=$((ATTEMPTS + 1))
              continue
            fi

            echo "Current stack status: $STATUS"

            # Fail if stack is in a failed or rollback state
            if [[ $STATUS == *FAILED* ]] || [[ $STATUS == *ROLLBACK* ]]; then
              echo "::error::Stack is in a failed or rollback state: $STATUS"
              exit 1
            fi

            # Continue if stack is ready
            if [[ $STATUS == "CREATE_COMPLETE" ]] || [[ $STATUS == "UPDATE_COMPLETE" ]]; then
              echo "::notice::Stack is ready with status: $STATUS"
              break
            fi

            # Wait and check again if stack is still being created/updated
            if [[ $STATUS == *IN_PROGRESS* ]]; then
              echo "Stack operation in progress. Waiting 30 seconds..."
              sleep 30
              ATTEMPTS=$((ATTEMPTS + 1))
              continue
            fi
          done

          if [ $ATTEMPTS -eq ${{ env.MAX_ATTEMPTS }} ]; then
            echo "::error::Timeout waiting for stack to be ready"
            exit 1
          fi

      - name: Get EC2 Instance ID
        id: get-instance
        run: |
          INSTANCE_ID=$(aws cloudformation describe-stack-resources \
            --stack-name ${{ env.STACK_NAME }} \
            --logical-resource-id EC2Instance \
            --query 'StackResources[0].PhysicalResourceId' \
            --output text)
          if [ -z "$INSTANCE_ID" ]; then
            echo "::error::Failed to get EC2 instance ID"
            exit 1
          fi
          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT

      - name: Wait for instance to be ready
        run: |
          aws ec2 wait instance-status-ok \
            --instance-ids ${{ steps.get-instance.outputs.instance_id }}

      - name: Run deployment script on EC2
        id: deploy
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${{ steps.get-instance.outputs.instance_id }} \
            --document-name "AWS-RunShellScript" \
            --parameters commands=["cd /quadratic-selfhost && ./login.sh && ./pull_start.sh"] \
            --comment "Deploying new images after build" \
            --query 'Command.CommandId' \
            --output text)

          # Wait for command completion
          ATTEMPTS=0
          echo "Waiting for deployment command to complete..."
          while [ $ATTEMPTS -lt ${{ env.MAX_ATTEMPTS }} ]; do
            ATTEMPTS=$((ATTEMPTS + 1))

            STATUS=$(aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id ${{ steps.get-instance.outputs.instance_id }} \
              --query "Status" \
              --output text 2>/dev/null || echo "Pending")

            echo "$ATTEMPTS/${{ env.MAX_ATTEMPTS }} - Command status: $STATUS"

            if [ "$STATUS" = "Success" ]; then
              echo "Deployment completed successfully"
              exit 0
            elif [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Cancelled" ] || [ "$STATUS" = "TimedOut" ]; then
              echo "Deployment failed with status: $STATUS"

              # Get command output for debugging
              aws ssm get-command-invocation \
                --command-id "$COMMAND_ID" \
                --instance-id ${{ steps.get-instance.outputs.instance_id }} \
                --query "StandardOutputContent" \
                --output text

              exit 1
            fi

            [ $ATTEMPTS -lt ${{ env.MAX_ATTEMPTS }} ] && sleep 30
          done

          echo "Deployment timed out after ${{ env.MAX_ATTEMPTS }} attempts"
          exit 1

      - name: Generate Deploy Metadata
        id: deploy-metadata
        run: |
          # Sanitize branch name for DNS
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          SANITIZED_BRANCH_NAME=$(echo "$BRANCH_NAME" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]/-/g' | sed 's/-\+/-/g' | sed 's/^-\|-$//')

          echo "WEBSITE_URL=${SANITIZED_BRANCH_NAME}.quadratic-preview.com" >> $GITHUB_OUTPUT
          echo "DEPLOY_TIME=$(date -u +'%b %d, %Y at %I:%M %p UTC')" >> $GITHUB_OUTPUT

      - name: Find Build & Deploy Images Comment
        if: always()
        uses: peter-evans/find-comment@v3
        id: preview-build-deploy-images-comment-update
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: "github-actions[bot]"
          body-includes: "Preview - Build, Deploy & Tests-E2E"

      - name: Update comment on deploy images success
        if: success()
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ steps.preview-build-deploy-images-comment-update.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## Preview - Build, Deploy & Tests-E2E
            ‚úÖ Build images
            ‚úÖ Deploy images - ${{ steps.deploy-metadata.outputs.DEPLOY_TIME }} - [Preview](https://${{ steps.deploy-metadata.outputs.WEBSITE_URL }})
            ‚è≥ Tests-E2E - [Previous Report](https://e2e.quadratic-preview.com/pr-${{ github.event.pull_request.number }})

            üîç Please check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.
          edit-mode: replace

      - name: Update comment on deploy images failure
        if: failure()
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ steps.preview-build-deploy-images-comment-update.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## Preview - Build, Deploy & Tests-E2E
            ‚úÖ Build images
            ‚ùå Deploy images
            ‚ùå Tests-E2E

            üîç Please check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.
          edit-mode: replace

      - name: Update deployment status (success)
        if: success()
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/deployments/${{ needs.create_deployment.outputs.deployment_id }}/statuses \
            -f state="success" \
            -f environment_url="https://${{ steps.deploy-metadata.outputs.WEBSITE_URL }}" \
            -f description="Deployment successful!" \
            -f environment=preview-pr-${{ github.event.pull_request.number }} \
            -f log_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update deployment status (failure)
        if: failure()
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            /repos/${{ github.repository }}/deployments/${{ needs.create_deployment.outputs.deployment_id }}/statuses \
            -f state="failure" \
            -f description="Deployment failed" \
            -f environment=preview-pr-${{ github.event.pull_request.number }} \
            -f log_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Find Build & Deploy Images Comment (cancelled)
        if: cancelled()
        uses: peter-evans/find-comment@v3
        id: preview-build-deploy-images-comment-cancelled
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: "github-actions[bot]"
          body-includes: "Preview - Build, Deploy & Tests-E2E"

      - name: Update comment on deploy images cancelled
        if: cancelled()
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ steps.preview-build-deploy-images-comment-cancelled.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## Preview - Build, Deploy & Tests-E2E
            ‚úÖ Build images
            üö´ Deploy images - [Cancelled](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            üö´ Tests-E2E

            üîç [Workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          edit-mode: replace

  verify_deployed_version:
    name: Verify Version
    needs: [build_images, deploy_images]
    runs-on: blacksmith-2vcpu-ubuntu-2404
    timeout-minutes: 30
    strategy:
      matrix:
        service:
          - name: client
            url: "https://${{ needs.deploy_images.outputs.WEBSITE_URL }}/version.json"
          - name: api
            url: "https://api.${{ needs.deploy_images.outputs.WEBSITE_URL }}/health"
          - name: multiplayer
            url: "https://multiplayer.${{ needs.deploy_images.outputs.WEBSITE_URL }}/health"
          - name: connection
            url: "https://connection.${{ needs.deploy_images.outputs.WEBSITE_URL }}/health"
          - name: files
            url: "https://files.${{ needs.deploy_images.outputs.WEBSITE_URL }}/health"
          - name: cloud-controller
            url: "https://cloud-controller.${{ needs.deploy_images.outputs.WEBSITE_URL }}/health"
      fail-fast: false
    env:
      EXPECTED_VERSION: ${{ needs.build_images.outputs.version }}
      MAX_ATTEMPTS: 50
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          sparse-checkout: |
            .github/actions/verify-version
          sparse-checkout-cone-mode: false
          fetch-tags: false
          submodules: false
          lfs: false

      - name: Verify ${{ matrix.service.name }} version
        uses: ./.github/actions/verify-version
        with:
          service_name: ${{ matrix.service.name }}
          service_url: ${{ matrix.service.url }}
          expected_version: ${{ env.EXPECTED_VERSION }}
          max_attempts: ${{ env.MAX_ATTEMPTS }}

  test-e2e-start-comment:
    name: Tests-E2E - Generate Matrix and Start Comment
    needs: [build_images, deploy_images, verify_deployed_version]
    permissions:
      contents: read
      pull-requests: write
      issues: write
    runs-on: blacksmith-2vcpu-ubuntu-2404
    timeout-minutes: 15
    outputs:
      matrix: ${{ steps.generate-matrix.outputs.matrix }}
    env:
      matrix_runner: 164
      e2e_url: ${{ needs.deploy_images.outputs.WEBSITE_URL }}
      deploy_time: ${{ needs.deploy_images.outputs.DEPLOY_TIME }}
    steps:
      - name: Generate Test Matrix
        id: generate-matrix
        run: |
          # Create a matrix with shardIndex values from 1 to matrix_runner
          # Use -c flag for compact (single-line) JSON output required by $GITHUB_OUTPUT
          matrix=$(jq -c -n --argjson runner "${{ env.matrix_runner }}" '{"shardIndex": [range(1; $runner + 1)], "shardTotal": [$runner]}')
          echo "matrix=$matrix" >> $GITHUB_OUTPUT
          echo "Generated matrix: $matrix"

      - name: Find Build & Deploy Images Comment
        uses: peter-evans/find-comment@v3
        id: test-e2e-start-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: "github-actions[bot]"
          body-includes: "Preview - Build, Deploy & Tests-E2E"

      - name: Update comment on E2E tests start
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ steps.test-e2e-start-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## Preview - Build, Deploy & Tests-E2E
            ‚úÖ Build images
            ‚úÖ Deploy images - ${{ env.deploy_time }} - [Preview](https://${{ env.e2e_url }})
            ‚è≥ Tests-E2E running... - [Partial Report](https://e2e.quadratic-preview.com/pr-${{ github.event.pull_request.number }}) (updates as shards complete)

            üîç Please check the [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.
          edit-mode: replace

  test-e2e-matrix-run:
    name: Tests-E2E - Matrix Run, Shard
    needs:
      [
        build_images,
        deploy_images,
        verify_deployed_version,
        test-e2e-start-comment,
      ]
    runs-on: blacksmith-2vcpu-ubuntu-2404
    container:
      image: mcr.microsoft.com/playwright:v1.58.1-noble
      options: --user root
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.test-e2e-start-comment.outputs.matrix) }}
    env:
      e2e_url: ${{ needs.deploy_images.outputs.WEBSITE_URL }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          sparse-checkout: |
            .github/actions/tests-e2e
          sparse-checkout-cone-mode: false
          fetch-tags: false
          submodules: false
          lfs: false

      - name: Run tests e2e
        uses: ./.github/actions/tests-e2e
        id: run-tests-e2e
        with:
          e2e_url: "https://${{ env.e2e_url }}"
          shard_index: ${{ matrix.shardIndex }}
          shard_total: ${{ matrix.shardTotal }}

  test-e2e-partial-reports:
    name: Tests-E2E - Partial Reports
    needs:
      [
        build_images,
        deploy_images,
        verify_deployed_version,
        test-e2e-start-comment,
      ]
    permissions:
      contents: read
      pull-requests: write
      issues: write
    runs-on: blacksmith-2vcpu-ubuntu-2404
    timeout-minutes: 14
    env:
      e2e_url: ${{ needs.deploy_images.outputs.WEBSITE_URL }}
      deploy_time: ${{ needs.deploy_images.outputs.DEPLOY_TIME }}
      s3_bucket: e2e.quadratic-preview.com
      total_shards: 164
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          sparse-checkout: |
            test/e2e
          sparse-checkout-cone-mode: false
          fetch-tags: false
          submodules: false
          lfs: false

      - name: Setup Node
        uses: useblacksmith/setup-node@v5
        with:
          node-version: 24

      - name: Install Dependencies
        run: cd test/e2e && npm install

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_PREVIEW }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_PREVIEW }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Generate partial reports periodically
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');
            const fs = require('fs');
            const path = require('path');

            const runId = '${{ github.run_id }}';
            const s3Bucket = '${{ env.s3_bucket }}';
            const prNumber = '${{ github.event.pull_request.number }}';
            const totalShards = parseInt('${{ env.total_shards }}');
            const e2eUrl = '${{ env.e2e_url }}';
            const deployTime = '${{ env.deploy_time }}';
            const workflowUrl = '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}';

            // Helper function to update PR comment
            async function updatePRComment(shardCount, passed, failed, flaky) {
              const completionPercent = Math.round((shardCount / totalShards) * 100);

              // Build status line with stats
              let statusParts = [`‚è≥ Tests-E2E running... ${shardCount}/${totalShards} shards (${completionPercent}%)`];
              if (failed > 0) statusParts.push(`‚ùå ${failed} failed`);
              if (passed > 0) statusParts.push(`‚úÖ ${passed} passed`);
              if (flaky > 0) statusParts.push(`üîÑ ${flaky} flaky`);

              const statusLine = statusParts.join(' | ');

              const body = `## Preview - Build, Deploy & Tests-E2E
            ‚úÖ Build images
            ‚úÖ Deploy images - ${deployTime} - [Preview](https://${e2eUrl})
            ${statusLine} - [Partial Report](https://${s3Bucket}/pr-${prNumber})

            üîç [Workflow run](${workflowUrl})`;

              try {
                // Find existing comment
                const { data: comments } = await github.rest.issues.listComments({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: parseInt(prNumber),
                });

                const botComment = comments.find(c =>
                  c.user?.login === 'github-actions[bot]' &&
                  c.body?.includes('Preview - Build, Deploy & Tests-E2E')
                );

                if (botComment) {
                  await github.rest.issues.updateComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    comment_id: botComment.id,
                    body: body
                  });
                  console.log('Updated PR comment with partial status');
                }
              } catch (e) {
                console.log(`Failed to update PR comment: ${e.message}`);
              }
            }

            // Wait 60 seconds before first check to allow some shards to complete
            console.log('Waiting 60 seconds before first partial report...');
            await new Promise(r => setTimeout(r, 60000));

            let lastReportedShards = 0;
            const maxIterations = 12; // Run for up to ~12 minutes (60s initial + 12 * 60s)

            for (let i = 0; i < maxIterations; i++) {
              console.log(`\n=== Partial report iteration ${i + 1}/${maxIterations} ===`);

              try {
                // Download available blob reports
                execSync('rm -rf all-blob-reports', { stdio: 'inherit' });

                try {
                  execSync(`gh run download ${runId} --pattern "blob-report-${runId}-*" --dir all-blob-reports`, {
                    stdio: 'inherit',
                    env: { ...process.env, GH_TOKEN: '${{ github.token }}' }
                  });
                } catch (e) {
                  console.log('No blob reports available yet, waiting...');
                  await new Promise(r => setTimeout(r, 60000));
                  continue;
                }

                // Count downloaded shard reports
                let shardCount = 0;
                if (fs.existsSync('all-blob-reports')) {
                  const dirs = fs.readdirSync('all-blob-reports');
                  shardCount = dirs.filter(d => d.startsWith('blob-report-')).length;

                  // Flatten the directory structure for merge-reports
                  for (const dir of dirs) {
                    const srcDir = path.join('all-blob-reports', dir);
                    if (fs.statSync(srcDir).isDirectory()) {
                      const files = fs.readdirSync(srcDir);
                      for (const file of files) {
                        fs.renameSync(
                          path.join(srcDir, file),
                          path.join('all-blob-reports', `${dir}-${file}`)
                        );
                      }
                      fs.rmdirSync(srcDir);
                    }
                  }
                }

                console.log(`Found ${shardCount} shard reports out of ${totalShards}`);

                // Only generate a new report if we have more shards than last time
                if (shardCount <= lastReportedShards) {
                  console.log('No new shards completed, waiting...');
                  await new Promise(r => setTimeout(r, 60000));
                  continue;
                }

                lastReportedShards = shardCount;

                // Check if we have all shards - if so, exit and let final job handle it
                if (shardCount >= totalShards) {
                  console.log('All shards completed, exiting to let final report job handle it');
                  break;
                }

                // Generate HTML report
                execSync('rm -rf playwright-report', { stdio: 'inherit' });
                execSync('npx playwright merge-reports --reporter html ./all-blob-reports', {
                  stdio: 'inherit',
                  cwd: process.cwd()
                });

                // Parse test results from the report to get failure count
                let passed = 0, failed = 0, flaky = 0, skipped = 0;
                try {
                  // Generate JSON report to get accurate counts
                  execSync('npx playwright merge-reports --reporter json ./all-blob-reports > report.json 2>/dev/null || true', {
                    stdio: 'pipe',
                    cwd: process.cwd()
                  });

                  if (fs.existsSync('report.json')) {
                    const report = JSON.parse(fs.readFileSync('report.json', 'utf8'));
                    passed = report.stats?.expected || 0;
                    failed = report.stats?.unexpected || 0;
                    flaky = report.stats?.flaky || 0;
                    skipped = report.stats?.skipped || 0;
                  }
                } catch (e) {
                  console.log('Could not parse JSON report for stats');
                }

                // Update PR comment with current status
                await updatePRComment(shardCount, passed, failed, flaky);

                // Add PARTIAL banner to index.html
                const indexPath = 'playwright-report/index.html';
                if (fs.existsSync(indexPath)) {
                  let html = fs.readFileSync(indexPath, 'utf8');

                  const completionPercent = Math.round((shardCount / totalShards) * 100);
                  const timestamp = new Date().toISOString().replace('T', ' ').substring(0, 19) + ' UTC';

                  const banner = `
            <div id="partial-banner" style="
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              z-index: 10000;
              background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
              color: white;
              padding: 12px 20px;
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
              font-size: 14px;
              font-weight: 500;
              text-align: center;
              box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            ">
              <span style="font-size: 16px; margin-right: 8px;">‚ö†Ô∏è</span>
              <strong>PARTIAL REPORT</strong> ‚Äî
              ${shardCount}/${totalShards} shards completed (${completionPercent}%)
              ${failed > 0 ? `<span style="background: #dc2626; padding: 2px 8px; border-radius: 4px; margin-left: 12px;">‚ùå ${failed} failed</span>` : ''}
              ${passed > 0 ? `<span style="background: #16a34a; padding: 2px 8px; border-radius: 4px; margin-left: 8px;">‚úÖ ${passed} passed</span>` : ''}
              ${flaky > 0 ? `<span style="background: #ca8a04; padding: 2px 8px; border-radius: 4px; margin-left: 8px;">üîÑ ${flaky} flaky</span>` : ''}
              <span style="margin-left: 16px; opacity: 0.9; font-size: 12px;">Updated: ${timestamp}</span>
            </div>
            <div style="height: 50px;"></div>`;

                  // Insert banner after <body> tag
                  html = html.replace(/<body[^>]*>/, match => match + banner);
                  fs.writeFileSync(indexPath, html);

                  console.log(`Added PARTIAL banner: ${shardCount}/${totalShards} shards, ${failed} failed, ${passed} passed`);
                }

                // Upload to S3
                execSync(`aws s3 sync playwright-report s3://${s3Bucket}/pr-${prNumber} --delete --cache-control "public, max-age=30"`, {
                  stdio: 'inherit'
                });

                console.log('Partial report uploaded to S3');

              } catch (error) {
                console.log(`Error in iteration ${i + 1}: ${error.message}`);
              }

              // Wait 60 seconds before next check
              if (i < maxIterations - 1) {
                console.log('Waiting 60 seconds before next check...');
                await new Promise(r => setTimeout(r, 60000));
              }
            }

            console.log('Partial report generation complete');

  test-e2e-merge-report-and-end-comment:
    name: Tests-E2E - Generate Report and End Comment
    needs:
      [
        build_images,
        deploy_images,
        verify_deployed_version,
        test-e2e-start-comment,
        test-e2e-matrix-run,
        test-e2e-partial-reports,
      ]
    permissions:
      contents: read
      pull-requests: write
      issues: write
    runs-on: blacksmith-2vcpu-ubuntu-2404
    if: always() && needs.test-e2e-start-comment.result == 'success'
    timeout-minutes: 15
    env:
      e2e_url: ${{ needs.deploy_images.outputs.WEBSITE_URL }}
      deploy_time: ${{ needs.deploy_images.outputs.DEPLOY_TIME }}
      s3_bucket: e2e.quadratic-preview.com
    steps:
      - name: Checkout code
        if: ${{ !cancelled() }}
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          sparse-checkout: |
            test/e2e
          sparse-checkout-cone-mode: false
          fetch-tags: false
          submodules: false
          lfs: false

      - name: Setup Node
        if: ${{ !cancelled() }}
        uses: useblacksmith/setup-node@v5
        with:
          node-version: 24

      - name: Install Dependencies
        if: ${{ !cancelled() }}
        run: cd test/e2e && npm install

      - name: Download blob reports
        if: ${{ !cancelled() }}
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          pattern: blob-report-${{ github.run_id }}-*
          path: all-blob-reports
          merge-multiple: true

      - name: Merge into HTML Report
        if: ${{ !cancelled() }}
        run: |
          if [ ! -d "all-blob-reports" ] || [ -z "$(ls -A all-blob-reports 2>/dev/null)" ]; then
            echo "No blob reports found. Creating empty report."
            mkdir -p playwright-report
            echo "<html><body><h1>No test reports available</h1><p>Tests may have been cancelled or failed to upload reports.</p></body></html>" > playwright-report/index.html
            exit 0
          fi
          file_count=$(find all-blob-reports -type f 2>/dev/null | wc -l || echo 0)
          echo "Merging $file_count blob reports into HTML report..."
          npx playwright merge-reports --reporter html ./all-blob-reports

      - name: Configure AWS Credentials
        if: ${{ !cancelled() }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_PREVIEW }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_PREVIEW }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Upload HTML report to S3
        if: ${{ !cancelled() }}
        run: |
          # Upload entire build directory to S3
          aws s3 sync playwright-report s3://${{ env.s3_bucket }}/pr-${{ github.event.pull_request.number }} \
            --delete --force \
            --cache-control "public, max-age=30"

      - name: Find Build & Deploy Images Comment
        if: always()
        uses: peter-evans/find-comment@v3
        id: test-e2e-merge-report-and-end-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: "github-actions[bot]"
          body-includes: "Preview - Build, Deploy & Tests-E2E"

      - name: Update comment on E2E tests end
        if: ${{ !cancelled() }}
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ steps.test-e2e-merge-report-and-end-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## Preview - Build, Deploy & Tests-E2E
            ‚úÖ Build images
            ‚úÖ Deploy images - ${{ env.deploy_time }} - [Preview](https://${{ env.e2e_url }})
            ${{ needs.test-e2e-matrix-run.result == 'success' && '‚úÖ' || '‚ùå' }} Tests-E2E  -  [Report](https://${{ env.s3_bucket }}/pr-${{ github.event.pull_request.number }})

            üîç [Workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          edit-mode: replace

      - name: Update comment on E2E tests end
        if: cancelled()
        uses: peter-evans/create-or-update-comment@v3
        with:
          comment-id: ${{ steps.test-e2e-merge-report-and-end-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## Preview - Build, Deploy & Tests-E2E
            ‚úÖ Build images
            ‚úÖ Deploy images - ${{ env.deploy_time }} - [Preview](https://${{ env.e2e_url }})
            üö´ Tests-E2E - [Cancelled](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            üîç [Workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          edit-mode: replace

  # This job provides a single required status check for branch protection.
  # It will fail if any e2e test shard fails, ensuring PRs cannot be merged
  # with failing e2e tests.
  test-e2e-status:
    name: Tests-E2E Status
    needs: [test-e2e-matrix-run]
    runs-on: blacksmith-2vcpu-ubuntu-2404
    if: always()
    timeout-minutes: 5
    steps:
      - name: Check E2E test results
        run: |
          if [ "${{ needs.test-e2e-matrix-run.result }}" != "success" ]; then
            echo "E2E tests failed or were cancelled. Result: ${{ needs.test-e2e-matrix-run.result }}"
            exit 1
          fi
          echo "All E2E tests passed successfully!"
