name: Claude PR Code Review
on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened, labeled]

jobs:
  review:
    if: "${{ contains(github.event.pull_request.labels.*.name, 'status: ready for claude review') }}"
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          model: claude-opus-4-5
          timeout_minutes: 30
          allowed_tools: |
            Read
            Grep
            Glob
            Bash(find:*)
            Bash(ls:*)
            mcp__github_inline_comment__create_inline_comment
            Bash(gh pr comment:*)
            Bash(gh pr diff:*)
            Bash(gh pr view:*)
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            Please review this pull request with a focus on:
            - Code quality and best practices
            - Potential bugs or issues
            - Security implications
            - Performance considerations

            First, use `gh pr diff ${{ github.event.pull_request.number }}` to see what changed.
            Then read relevant files for context if needed.

            Provide detailed feedback using inline comments for specific issues.

            Only leave comments related to negative feedback.

            You don't need to comment every time if you don't have anything substantive to add; only provide substantive feedback.
